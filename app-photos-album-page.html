<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../app-localize-mixin/app-localize-mixin.html">
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="../goc-styles/goc-styles.html">
<link rel="import" href="../goc-toolbar-layout/goc-toolbar-layout.html">
<link rel="import" href="../goc-buttons/goc-icon-button.html">
<link rel="import" href="../input-file/input-file.html">
<link rel="import" href="../dropdown-menu/dropdown-menu-container.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../selectable-item/selectable-group.html">
<link rel="import" href="../iron-list/iron-list.html">

<dom-module id="app-photos-album-page">
  <template>
    <style include="missing-well-styles">
      :host {
        background: var(--goc-background-color);
        display: block;
        height: 100%;
      }

      #inputFile {
        display: none;
      }

      iron-list {
        height: 100%;
      }

      .photo {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 160px;
        height: 160px;
      }

      .photo__iron-image {
        width: calc(100% - 8px);
        height: calc(100% - 8px);
      }

      /* disabled album message */
      .disabled-album-notice {
        background: var(--paper-grey-300);
        border-radius: 4px;
        box-sizing: border-box;
        color: var(--paper-grey-600);
        font-size: 14px;
        font-weight: bold;
        margin: 10px 10px 6px 10px;
        padding: 10px 20px;
        text-align: center;
      }
    </style>

    <app-route
        route="[[route]]"
        pattern="/:albumTitle"
        data="{{_routeData}}"></app-route>

    <input-file
        id="inputFile"
        content-id$="[[contentId]]"
        on-files-selected="_onFilesSelected"
        on-files-loaded="_onFilesLoaded"></input-file>

    <goc-toolbar-layout full-width>

      <!-- main toolbar -->
      <goc-toolbar
          slot="toolbar"
          heading="[[_album.title]]"
          subheading="[[_computedSubheading(_album.photos.length, _album.enabled, localize, visible)]]"
          loading="[[loading]]">

        <goc-icon-button
            slot="toolbar-left"
            icon="arrow-back"
            theme="primary"
            on-click="_onBackTapped"></goc-icon-button>

        <goc-icon-button
            slot="toolbar-right"
            icon="add-photo"
            theme="primary"
            on-click="_onSelectFilesTapped"
            title="[[localize('AddPhotosButton.title')]]"></goc-icon-button>

        <dropdown-menu-container slot="toolbar-right">
          <goc-icon-button
              icon="dots-vertical"
              theme="primary"
              title="[[localize('MoreMenu.Title')]]"></goc-icon-button>

          <template is="dom-template">
            <button on-click="_selectAllPhotos">[[localize('MoreMenu.SelectAll')]]</button>
            <button on-click="_onToggleEnableAlbumTapped">[[_computedToggleAlbumText(album.enabled)]]</button>
            <button on-click="_onEditAlbumTapped">[[localize('MoreMenu.Edit')]]</button>
            <button on-click="_onDeleteAlbumTapped">[[localize('MoreMenu.Delete')]]</button>
          </template>
        </dropdown-menu-container>
      </goc-toolbar>
      
      <!-- selection toolbar -->
      <goc-toolbar
          slot="toolbar"
          heading="[[selection.length]]"
          active="[[_activeSelection]]"
          theme="primary">

        <goc-icon-button
            slot="toolbar-left"
            icon="close"
            title="[[localize('SelectionToolbar.CancelSelection')]]"
            on-click="_onCancelSelection"></goc-icon-button>

        <goc-icon-button
            slot="toolbar-right"
            icon="delete"
            title="[[localize('SelectionToolbar.RemoveSelectedPhotos')]]"
            on-click="_onRemoveSelectionTapped"></goc-icon-button>

      </goc-toolbar>

      <!-- content start here -->
      <dom-if if="[[_computedIsDisabled(_album.enabled)]]">
        <template>
          <div class="disabled-album-notice">[[localize('DisabledAlbumNotice')]]</div>
        </template>
      </dom-if>

      <dom-if if="[[_computedMisingPhotosIf(_album, _album.photos.length)]]">
        <template>
          <div class="missing-well">
            <div class="missing-well__title">[[localize('EmptyPhotos.Title')]]</div>
          </div>
        </template>
      </dom-if>

      <selectable-group id="selectableGroup" active-selection="{{_activeSelection}}">
        <iron-list items="[[_album.photos]]" grid>
          <template>
            <selectable-item class="photo">
              <iron-image
                  class="photo__iron-image"
                  src="[[_computedThumbnailUrl(item.images)]]"
                  preload
                  sizing="cover"
                  on-error="_imageLoadError"></iron-image>
            </selectable-item>
          </template>
        </iron-list>
      </selectable-group>

    </goc-toolbar-layout>

  </template>

  <script>

    class AppPhotosAlbumPage extends AppLocalizeMixin(Polymer.Element) {

      static get is() {return 'app-photos-album-page';}

      static get properties() {
        return {

          data: Object,

          contentId: String,

          language: String,

          visible: Boolean,

          resources: {
            type: Object,
            value: _ => {
              return {
                "en": {
                  "AddPhotosButton.title": "Add photos",
                  "MoreMenu.Title": "More",
                  "MoreMenu.SelectAll": "Select all",
                  "MoreMenu.Edit": "Edit details",
                  "MoreMenu.Delete": "Delete album",
                  "MoreMenu.Enable": "Enable album",
                  "MoreMenu.Enable": "Disable album",
                  "SelectionToolbar.CancelSelection": "Cancel selection",
                  "SelectionToolbar.RemoveSelectedPhotos": "Remove selected photos",
                  "EmptyPhotos.Title": "This album is empty.",
                  "DisabledAlbumNotice": "This album is disabled. These photos won't be displayed.",
                  "Toolbar.PhotosLength": "{length} photos",
                  "Toolbar.Disabled": "Disabled"
                },
                "es": {

                }
              };
            }
          },

          route: Object,

          _album: Object,

          _routeData: Object,

          _activeSelection: {
            type: Boolean,
            value: false
          }

        };
      }

      static get observers() {
        return [
          '_routePageChanged(_routeData.albumTitle, data.albums.*, visible)',
        ];
      }

      constructor() {
        super();
        this._newAlbumOverlay = null;
        this._uploadedFiles = {};
        this._uploadingFiles = 0;
      }

      _routePageChanged(albumTitle, albumsChange, visible) {
        if (!visible) {
          this._album = {};
        } else {
          this._album = (this.data.albums || []).filter(a => {
            return String(a.title).trim() === String(albumTitle).trim();
          })[0];
        }
      }

      _selectAllPhotos() {
      }

      _onSelectFilesTapped() {
        this.$.inputFile.selectFiles();
      }

      _onFilesSelected() {
        const files = event.detail.files;

        event.detail.thumbnailSizes = [
          {width: 300, height: 300}
        ];

        this._uploadingFiles = this._uploadingFiles + files.length;
      }

      _onFilesLoaded() {
        const files = event.detail.files;

        // what to do when there is an error?
        for (let i = 0; i < files.length; i++) {
          this._uploadingFiles --;

          const file = files[i];

          // Falta guarda en el data el tamaño de la imagen original
          if (file.images) {
            const parts = file.name.split('.');
            parts.pop();
            const filename = parts.join('.').replace(/[^\w-]/g,'');
            this._uploadedFiles[filename] = file;

            requestAnimationFrame(_ => {
              if (!this._album.photos) {
                this._album.photos = [];
              }

              this.push('_album.photos', {images: file.images});

              this.dispatchEvent(new Event('trigger-update', {
                composed: true,
                bubbles: true,
                detail: {
                  // save inmediately every 3 photos at least
                  inmediate: this._uploadingFiles % 3 === 0
                }
              }));
            });
          }
        }
      }

      _onBackTapped() {
        window.history.pushState({}, null, '#');
        window.dispatchEvent(new CustomEvent('location-changed'));
      }

      _onToggleEnableAlbumTapped(event) {
        this.set('_album.enabled', this._album.enabled === false ? true : false);

        this.dispatchEvent(new Event('trigger-update', {
          composed: true,
          bubbles: true
        }));
      }

      _computedThumbnailUrl(images) {
        if (images) {
          // Get smallest one. When no width, is the original (we consider it
          // the  biggest)
          return images.sort((a,b) => {
            return (a.width || Infinity) - (b.width || Infinity);
          })[0].url;
        }        
      }

      _computedIsDisabled(enabled) {
        return enabled === false;
      }

      _computedMisingPhotosIf(_album, photosLength) {
        if (_album && !photosLength) {
          return true;
        }
        return false;
      }

      _computedToggleAlbumText(albumEnabled) {
        if (enabled === false) {
          return this.localize('MoreMenu.Enable');
        }
        return this.localize('MoreMenu.Disable');
      }

      _computedSubheading(photosLength, albumEnabled, localize, visible) {
        let subheading = this.localize('Toolbar.PhotosLength', 'length', String(photosLength || 0));

        if (albumEnabled === false) {
          subheading += ' · ' + this.localize('Toolbar.Disabled');
        }

        return subheading;
      }

    }

    customElements.define(AppPhotosAlbumPage.is, AppPhotosAlbumPage);

  </script>
</dom-module>