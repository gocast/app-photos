<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../app-route/app-location.html">
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../goc-icons/goc-icons.html">
<link rel="import" href="../goc-styles/goc-styles.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../input-file/input-file.html">
<link rel="import" href="../dropdown-menu/dropdown-menu-container.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../selectable-item/selectable-group.html">
<link rel="import" href="../fluid-grid/fluid-grid.html">
<link rel="import" href="app-photos-new-album-overlay.html">

<!--
`app-photos-album-page`


@demo demo/app-photos-album-page.html
-->
<dom-module id="app-photos-album-page">
  <template>
    <style include="header-layout-styles missing-well-styles">
      :host {
        background: var(--goc-background-color);
        display: block;
        height: 100%;
      }

      .header-layout__content {
        max-width: 100%;
        padding: 0;
      }

      #inputFile {
        display: none;
      }

      .disabled-message {
        background: var(--paper-grey-300);
        border-radius: 4px;
        box-sizing: border-box;
        color: var(--paper-grey-600);
        font-size: 14px;
        font-weight: bold;
        margin: 10px 10px 6px 10px;
        padding: 10px 20px;
        text-align: center;
      }

      fluid-grid {
        margin-left: 4px;
      }

      selectable-item {
        background: var(--paper-grey-200);
        cursor: pointer;
        display: inline-block;
        float: left;
        margin: 4px 4px 0 0;
      }

      .photo__iron-image {
        background: white;
        height: 100%;
        width: 100%;
        --iron-image-placeholder: {
          background: var(--paper-grey-300);
        }
      }
    </style>

    <app-location route="{{route}}" use-hash-as-path></app-location>
    <app-route
        route="[[route]]"
        pattern="/album/:albumTitle"
        data="{{routeData}}"></app-route>

    <input-file
        id="inputFile"
        on-files-selected="_onFilesSelected"
        on-files-loaded="_onFilesLoaded"></input-file>

    <div class="header-layout">
      <div class="header-layout__header">
        <div class="header-toolbar">
         <a href="#">
            <paper-icon-button icon="arrow-back"></paper-icon-button>
          </a>
          <div class="header-toolbar__main-content">
            <div class="header-toolbar__title">[[album.title]]</div>
            <div class="header-toolbar__subtitle">
              [[_computeAlbumLengthText(album.photos.length, localize, visible)]]
              [[_computeAlbumEnabledText(album.enabled, localize)]]
            </div>
          </div>
          <paper-spinner-lite class="header-toolbar__spinner" active="[[loading]]"></paper-spinner-lite>
          <paper-icon-button icon="add-photo" on-tap="_selectFilesTapped" title="[['AlbumPage.Header.UploadPhotos.AriaLabel']]"></paper-icon-button>

          <dropdown-menu-container>
            <paper-icon-button icon="dots-vertical" title="[[localize('AlbumMenu.AriaLabel')]]"></paper-icon-button>

            <template is="dom-template">
              <button on-tap="_selectAll">[[localize('AlbumPage.MoreMenu.SelectAll')]]</button>
              <button on-tap="_toggleEnableAlbumTapped">[[_computeToggleAlbumText(album.enabled)]]</button>
              <button on-tap="_editAlbumTapped">[[localize('AlbumMenu.Edit')]]</button>
              <button on-tap="_deleteAlbumTapped">[[localize('AlbumMenu.Delete')]]</button>
            </template>
          </dropdown-menu-container>
        </div>

        <div class$="[[_computeSecondaryToolbarClass(activeSelection)]]">
          <paper-icon-button
              icon="close"
              on-tap="_cancelSelection"
              title="[[localize('AlbumPage.SelectionToolbar.CancelSelection')]]"></paper-icon-button>
          <div class="header-toolbar__main-content">
            <div class="header-toolbar__title">[[selection.length]]</div>
          </div>
          <paper-icon-button
              icon="delete"
              on-tap="_removeSelectionTapped"
              title="[[localize('AlbumPage.SelectionToolbar.RemoveSelectedPhotos')]]"></paper-icon-button>
        </div>
      </div>

      <div class="header-layout__content">
        <template is="dom-if" if="[[_computeIsDisabled(album.enabled)]]">
         <div class="disabled-message">[[localize('AlbumPage.DisabledMessage')]]</div>
        </template>
        <fluid-grid item-selector=".photo" container-selector="selectable-group" min-width="160px" margin-width="4px" visible="[[visible]]" auto-height>
          <selectable-group id="selectableGroup" active-selection="{{activeSelection}}">
            <template id="domRepeat" is="dom-repeat" items="[[_computedDomRepeat(album.photos.*)]]" as="photo">
              <selectable-item class="photo">
                <iron-image
                    class="photo__iron-image"
                    src="[[_computedThumbnailUrl(photo.urls)]]"
                    preload
                    sizing="cover"
                    on-error-changed="_imageLoadError"></iron-image>
              </selectable-item>
            </template>
          </selectable-group>
        </fluid-grid>

        <template is="dom-if" if="[[!album.photos.length]]">
          <div class="missing-well">
            <div class="missing-well__title">[[localize('AlbumPage.MissingPhotos.Title')]]</div>
          </div>
        </template>
      </div>
    </div>

  </template>
</dom-module>

<script>
(function() {
  'use strict';

  Polymer({

    is: 'app-photos-album-page',

    properties: {

      albums: {
        type: Array,
        notify: true
      },

      album: Object,

      activeSelection: {
        type: Boolean,
        value: false
      },

      visible: Boolean,

      _newAlbumOverlay: Object,

      _uploadedFiles: {
        type: Object,
        value: _ => {
          return {};
        }
      },

      // Number of files being uploaded
      _uploadingFiles: {
        type: Number,
        value: 0
      },
  
      language: {
        type: String,
        value: 'en'
      }

    },

    behaviors: [
      Polymer.AppLocalizeBehavior
    ],

    observers: [
      '_routePageChanged(routeData.albumTitle, albums.length, visible)',
    ],

    attached() {
      this.loadResources(this.resolveUrl('locales/app.json'));
    },

    _routePageChanged(albumTitle) {
      if (!this.visible) {
        this.album = {};
        return;
      }

      if (Array.isArray(this.albums)) {
        this.album = this.albums.filter(a => {
          return a.title === albumTitle;
        })[0];
      }

      setTimeout(_ => {
        if (!this.album) {
          this._historyPushState('#');
        }
      }, 10);
    },

    _selectAll() {
      this.$.selectableGroup.items.forEach(item => {
        item.selected = true;
      });
    },

    _cancelSelection() {
      this.$.selectableGroup.selection.forEach(item => {
        item.selected = false;
      });
    },

    _selectFilesTapped() {
      this.$.inputFile.selectFiles();
    },

    _computeSecondaryToolbarClass(activeSelection) {
      let classAttr = 'header-toolbar header-toolbar--secondary';
      if (activeSelection) {
        classAttr += ' header-toolbar--active';
      }
      return classAttr;
    },

    _removeSelectionTapped() {
      requestAnimationFrame(_ => {
        const selection = this.$.selectableGroup.selection;
        this._cancelSelection();

        selection.forEach(el => {
          const album = this.$.domRepeat.itemForElement(el);
          this.splice('album.photos', this.album.photos.indexOf(album), 1);
        });

        this.$.domRepeat.render();
        this._triggerUpdate({inmediate: true});
      });
    },

    _toggleEnableAlbumTapped(event) {
      this.set('album.enabled', this.album.enabled === false ? true : false);
      this._triggerUpdate({inmediate: true});
    },

    _editAlbumTapped(event) {
      if (this._newAlbumOverlay) {
        return;
      }

      this._newAlbumOverlay = this.create('app-photos-new-album-overlay', {
        opened: true,
        albums: this.albums,
        album: this.album,
        language: this.language,
        onDetach: _ => {
          this._newAlbumOverlay = null;
        }
      });

      this._newAlbumOverlay.addEventListener('overlay-closed', event => {
        if (!event.currentTarget.canceled) {
          const title = event.currentTarget.$.titleInput.value;
          this.set('album.title', title);
          this._triggerUpdate({inmediate: true});
        }
      });
    },

    _deleteAlbumTapped(event) {
      if (confirm('Delete this album?')) {
        this.splice('albums', this.albums.indexOf(this.album), 1);
        this._triggerUpdate({inmediate: true});
      }
    },

    _triggerUpdate({inmediate=false} = {}) {
      if (inmediate) {
        this.cancelDebouncer('save-changes');
        this.fire('trigger-update');
      } else {
        this.debounce('save-changes', _ => {
          this.fire('trigger-update');
        }, 4000);
      }
    },

    _historyPushState(url) {
      window.history.pushState({}, null, url);
      window.dispatchEvent(new CustomEvent('location-changed'));
    },

    _computedDomRepeat(albumChanges) {
      if (this.album && this.album.photos && this.album.photos.length) {
        return this.album.photos;
      }
      return [];
    },

    _computeAlbumLengthText(photosLength) {
      photosLength = photosLength || 0;
      return this.localize('AlbumDetails.PhotosLength', 'length', String(photosLength));
    },

    _computeAlbumEnabledText(enabled) {
      if (enabled === false) {
        return ' · ' + this.localize('AlbumDetails.Disabled');
      }
    },

    _computeToggleAlbumText(enabled) {
      if (enabled === false) {
        return this.localize('AlbumMenu.Enable');
      }
      return this.localize('AlbumMenu.Disable');
    },

    _computedThumbnailUrl(urls) {
      if (urls) {
        return urls.sort((a,b) => {
          return a.width - b.width;
        })[0].url;
      }
    },

    _computeIsDisabled(enabled) {
      return enabled === false;
    },
    
    // File upload
    _onFilesSelected(event) {
      const files = event.detail.files;

      event.detail.thumbnailSizes = [
        {width: 300, height: 300}
      ];

      this._uploadingFiles = this._uploadingFiles + files.length;
    },

    _onFilesLoaded(event) {
      const files = event.detail.files;
      console.log(files);
      return;

      // what when there is an error?
      for (let i = 0; i < files.length; i++) {
        this._uploadingFiles --;

        const file = files[i];

        // Falta guarda en el data el tamaño de la imagen original
        // Luego
        if (file.images) {
          const parts = file.name.split('.');
          parts.pop();
          const filename = parts.join('.');
          this._uploadedFiles[filename] = file;

          requestIdleCallback(_ => {
            this.push('album.photos', {images: file.images});
            this.$.domRepeat.render();

            // save inmediately every 3 at least
            // and every single one let the debounce be
            this._triggerUpdate({
              inmediate: this._uploadingFiles % 3 === 0
            });
          });
        }
      }
    },

    _imageLoadError(event) {
      return;
      if (event.detail.value) {
        const item = event.model.photo;
        const urls = item.urls;
        if (urls) {
          const original = urls.find(item => {
            const reg = new RegExp(`-${item.width}-${item.height}\\.\\w+`);
            return !item.url.match(reg);
          });
          try {
            const filename = original.url.match(/\/([^\/]*)$/)[1];
            const parts = filename.split('.');
            parts.pop();
            const name = parts.join('.');
            const file = this._uploadedFiles[name];
            const fileTmpUrl = URL.createObjectURL(file);
            const ironImage = event.path[0];
            ironImage.src = fileTmpUrl;
            this._uploadedFiles[name] = null;
          } catch(err) {
            // If not possible, load from network few times and at last
            // try the original
            const ironImage = event.path[0];
            if (item.retries === null) {
              // no image available
              return;
            }
            item.retries = item.retries || 0;
            item.retries ++;
            if (item.retries < 3) {
              // Try the same again
              this.async(_ => ironImage._load(ironImage.src), item.retries * 1500);
            } else if (item.retries !== null){
              item.retries = null;
              // try original
              if (original) {
                ironImage._load(original.url);
              }
            }
          }
        }
      }
    },

  });

}());
</script>