<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="animated-pages">
  <template>
    <style>
      :host {
        display: block;
        height: 100%;
      }

      ::content > :not([visible]) {
        display: none !important;
      }

      ::content > .fix {
        bottom: 0;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
        z-index: 1;
      }
    </style>

    <slot></slot>
  </template>

  <script>

    class AnimatedPages extends Polymer.Element {

      static get is() {return 'animated-pages';}

      static get config() {
        return {
          properties: {

            page: {
              type: String,
              observer: '_pageChanged'
            },

            _isAttached: {
              type: Boolean,
              value: false,
            },

            _animation: Object

          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        this._isAttached = true;
        this._pageChanged(this.page);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        this._isAttached = false;
      }

      _pageChanged(page, old) {
        if (!this._isAttached) {
          return;
        }

        const pageElement = this.children.namedItem(page);
        const oldElement = this.children.namedItem(old);

        if (this._animation) {
          this._animation.finish();
          this._animation = null;
        }

        if (pageElement) {
          pageElement.style.display = 'block';
          pageElement.setAttribute('visible', true);
        } else {
          this.dispatchEvent(new CustomEvent('page-not-found', {
            composed: true,
            detail: {page},
          }));
        }

        this._animatePages(pageElement, oldElement).then(_ => {
          if (oldElement) {
            oldElement.removeAttribute('visible');
          }
        });
      }

      _animatePages(pageElement, oldElement) {
        return new Promise((resolve, reject) => {
          if (pageElement && oldElement) {
            document.body.style.overflow = 'hidden';
            pageElement.classList.add('fix');

            this._animation = pageElement.animate([
              {opacity: 0},
              {opacity: 1}
            ], 100);

            this._animation.onfinish = _ => {
              oldElement.style.display = 'none';
              pageElement.classList.remove('fix');
              requestAnimationFrame(_ => {
                document.body.style.overflow = '';
              });
              resolve();
            };
          } else {
            resolve();
          }
        });
      }

    }

    customElements.define(AnimatedPages.is, AnimatedPages);

  </script>
</dom-module>
