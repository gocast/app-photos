<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../app-localize-mixin/app-localize-mixin.html">
<link rel="import" href="../goc-toolbar-layout/goc-app-toolbar.html">
<link rel="import" href="../goc-styles/goc-styles.html">
<link rel="import" href="../goc-buttons/goc-button.html">
<link rel="import" href="../iron-list/iron-list.html">

<link rel="import" href="app-photos-new-album-overlay.html">

<dom-module id="app-photos-albums-page">
  <template>
    <style include="missing-well-styles">
      :host {
        background: var(--goc-background-color);
        display: block;
        height: 100%;
      }

      .header-layout__content {
        max-width: 100%;
        padding: 0;
      }

      iron-list {
        height: 100%;
      }
    </style>

    <goc-toolbar-layout>
      <goc-app-toolbar
          slot="toolbar"
          content-name="[[contentName]]"
          app-name="photos"
          language="[[language]]">

        <goc-button
            slot="toolbar-right"
            on-click="_createAlbumTapped"
            theme="primary">[[localize('Header.CreateAlbum')]]</goc-button>
      </goc-app-toolbar>

      <div class="albums">
      </div>
    </goc-toolbar-layout>

  </template>

  <script>

    class AppPhotosAlbumsPage extends AppLocalizeMixin(Polymer.Element) {

      static get is() {return 'app-photos-albums-page';}

      static get properties() {
        return {

          data: Object,

          language: String,

          contentName: String,

          resources: {
            type: Object,
            value: _ => {
              return {
                "en": {
                  "Header.CreateAlbum": "Create album",
                  "MissingAlbums.Title": "There are no albums."
                },
                "es": {
                  "Header.CreateAlbum": "Crear álbum",
                  "MissingAlbums.Title": "No has creado ningún álbum.",
                }
              };
            }
          }

        };
      }

      constructor() {
        super();
        this._newAlbumOverlay = null;
        this._newAlbumOverlayClosed = this._newAlbumOverlayClosed.bind(this);
      }

      _createAlbumTapped() {
        if (this._newAlbumOverlay) {
          return;
        }

        const overlay = document.createElement('app-photos-new-album-overlay')
        overlay.albums = this.data.albums;
        overlay.language = this.language;
        overlay.onDetach = _ => this._newAlbumOverlay = null;

        overlay.addEventListener('overlay-close-animation-finish',
          this._newAlbumOverlayClosed);

        this._newAlbumOverlay = overlay;        
        overlay.open();
      }

      _newAlbumOverlayClosed(event) {
        if (!event.currentTarget.canceled) {
          const title = event.currentTarget.$.titleInput.value;

          window.history.pushState({}, null, `#/album/${title}`);
          window.dispatchEvent(new Event('location-changed'));

          this.push('data.albums', {
            title,
            enabled: true,
            photos: []
          });

          this.dispatchEvent(new Event('trigger-update', {composed: true}));
        }
      }

    }

    customElements.define(AppPhotosAlbumsPage.is, AppPhotosAlbumsPage);

  </script>
</dom-module>
