<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../app-localize-mixin/app-localize-mixin.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../goc-styles/goc-styles.html">

<link rel="import" href="app-photos-new-album-overlay.html">

<dom-module id="app-photos-albums-page">
  <template>
    <style include="header-styles btn-styles icon-btn-styles missing-well-styles">
      :host {
        background: var(--goc-background-color);
        display: block;
        height: 100%;
      }

      .header-layout__content {
        max-width: 100%;
        padding: 0;
      }

      iron-list {
        height: 100%;
      }

    </style>

    <goc-toolbar-layout
        left-icon="arrow-back"
        on-left-icon-tapped="_closeApp"
        heading="[[contentName]]"
        subheading="[[appInfo.displayName]]"
        app-icon="photos">

      <div slot="toolbar-right-container">
        <button class="btn btn--primary" on-click="_createAlbumTapped">
          <touch-item>[[localize('Header.CreateAlbum')]]</touch-item>
        </button>  
      </div>

      <div slot="content">
        <iron-list class="albums" items="albums">
          <template>

          </template>
        </iron-list>        

        <dom-if>
          <template>
          </template>
        </dom-if>

      </div>
    </goc-toolbar-layout>

  </template>

  <script>

    class AppPhotosAlbumsPage extends AppLocalizeMixin(Polymer.Element) {

      static get is() {return 'app-photos-albums-page';}

      static get properties() {
        return {

          albums: {
            type: Array,
          },

          language: String,

          contentName: String,

          resources: {
            type: Object,
            value: _ => {
              return {
                "en": {
                  "Header.CreateAlbum": "Create album",
                  "MissingAlbums.Title": "There are no albums."
                },
                "es": {
                  "Header.CreateAlbum": "Crear álbum",
                  "MissingAlbums.Title": "No has creado ningún álbum.",
                }
              };
            }
          }

        };
      }

      constructor() {
        super();
        this._newAlbumOverlay = null;
        this._newAlbumOverlayClosed = this._newAlbumOverlayClosed.bind(this);
      }

      _closeApp() {
        this.dispatchEvent(new Event('close-app', {
          bubbles: true,
          composed: true
        }));
      }

      _createAlbumTapped() {
        if (this._newAlbumOverlay) {
          return;
        }

        const overlay = document.createElement('app-photos-new-album-overlay')
        overlay.albums = this.albums;
        overlay.language = this.language;
        overlay.onDetach = _ => this._newAlbumOverlay = null;

        overlay.addEventListener('overlay-close-animation-finish',
          this._newAlbumOverlayClosed);

        this._newAlbumOverlay = overlay;        
        overlay.open();
      }

      _newAlbumOverlayClosed(event) {
        if (!event.currentTarget.canceled) {
          const title = event.currentTarget.$.titleInput.value;

          window.history.pushState({}, null, `#/album/${title}`);
          window.dispatchEvent(new Event('location-changed'));

          this.push('albums', {
            title,
            enabled: true,
            photos: []
          });

          this.dispatchEvent(new Event('trigger-update', {composed: true}));
        }
      }

    }

    customElements.define(AppPhotosAlbumsPage.is, AppPhotosAlbumsPage);

  </script>
</dom-module>
