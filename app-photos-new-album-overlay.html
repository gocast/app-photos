<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../app-localize-mixin/app-localize-mixin.html">
<link rel="import" href="../goc-icons/goc-icons.html">
<link rel="import" href="../goc-styles/goc-styles.html">
<link rel="import" href="../overlay-container/animated-overlay-mixin.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">

<!--
`app-photos-new-album-overlay`


@demo demo/app-photos-new-album-overlay.html
-->
<dom-module id="app-photos-new-album-overlay">
  <template>
    <style include="header-layout-styles form-styles btn-styles icon-btn-styles">
      :host {
        background: var(--goc-background-color);
        bottom: 0;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
      }
    </style>

    <div class="header-layout">
      <div class="header-layout__header">
        <div class="header-toolbar">
          <button
              class="icon-btn icon-btn--primary"
              on-click="_onCloseTapped"
              title="[[localize('NewAlbumOverlay.Header.Button.Close')]]">
              <touch-item><iron-icon icon="close"></iron-icon></touch-item>
          </button>

          <div class="header-toolbar__main-content">
            <div class="header-toolbar__title">[[_computeHeaderTitle(album, localize)]]</div>
          </div>

          <paper-spinner-lite class="header-toolbar__spinner" active="[[loading]]"></paper-spinner-lite>

          <button class="btn btn--primary" on-click="_onSubmit">
            <touch-item>[[_computeHeaderSubmit(album, localize)]]</touch-item>
          </button>
        </div>
      </div>

      <div class="header-layout__content">
        <div class="form">
          <div class="form__item form__item--last">
            <label class="form__label">[[localize('NewAlbumOverlay.Form.TitleLabel')]]</label>
            <input
                id="titleInput"
                class="form__input"
                placeholder="[[localize('NewAlbumOverlay.Form.TitleLabel')]]"
                value$="[[album.title]]"
                on-keyup="_validate">
          </div>
        </div>
      </div>
    </div>

  </template>

  <script>

    class AppPhotosNewAlbumOverlay extends AnimatedOverlayMixin(AppLocalizeMixin(Polymer.Element)) {

      static get is() {return 'app-photos-new-album-overlay';}

      static get properties() {
        return {
          albums: Array,

          album: {
            type: Object,
            value: null
          },

          language: String,

          resources: Object,
        };
      }

      constructor() {
        super();
        this._overlayOpenAnimationFinished = this._overlayOpenAnimationFinished.bind(this);
        this._keydownPressed = this._keydownPressed.bind(this);
      }

      connectedCallback() {
        super.connectedCallback();
        this._toggleListeners({enable: true});
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        this._toggleListeners({enable: false});
      }

      _albumsChanged() {
        this._albumsTitles
      }

      _onSubmit() {
        if (this._validate()) {
          this._setCanceled(false);
          this.opened = false;
        }
      }

      _onCloseTapped() {
        this._setCanceled(true);
        this.opened = false;
      }

      _keydownPressed(event) {
        const enterKey = 13;
        if (event.keyCode === enterKey) {
          this._onSubmit();
        }
      }

      _overlayOpenAnimationFinished() {
        this.$.titleInput.focus();
      }

      _validate() {
        let valid = true;
        const title = this.$.titleInput.value;
        const titleValid = title.length && !this.albums.filter(album => {
          return album.title === title;
        }).length;

        valid = valid && titleValid;

        if (titleValid) {
          this.$.titleInput.parentElement.classList.remove('form__item--invalid');
        } else {
          this.$.titleInput.parentElement.classList.add('form__item--invalid');
        }
        return valid;
      }

      _toggleListeners({enable}) {
        const m = enable ? 'addEventListener' : 'removeEventListener';
        this[m]('overlay-open-animation-finish', this._overlayOpenAnimationFinished);
        this[m]('keydown', this._keydownPressed);
      }

      _computeHeaderTitle(album) {
        if (album) {
          return this.localize('NewAlbumOverlay.Header.EditTitle');
        }
        return this.localize('NewAlbumOverlay.Header.CreateTitle');
      }

      _computeHeaderSubmit(album) {
        if (album) {
          return this.localize('NewAlbumOverlay.Header.SubmitEdit');
        }
        return this.localize('NewAlbumOverlay.Header.SubmitCreate');
      }

    }

    customElements.define(AppPhotosNewAlbumOverlay.is, AppPhotosNewAlbumOverlay);

  </script>
</dom-module>