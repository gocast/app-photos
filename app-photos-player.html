<link rel="import" href="../polymer/polymer-element.html">

<!--
`app-photos-player`


@demo demo/index.html
-->

<dom-module id="app-photos-player">
  <template>
    <style>
      :host {
        display: block;
      }

      #container {
        height: 100%;
        position: relative;
        width: 100%;
      }

      #container iron-image {
        bottom: 0;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
      }
    </style>

    <div id="container"></div>

  </template>

  <script>

    class AppPhotosPlayer extends Polymer.Element {

      static get is() {return 'app-photos-player';}

      static get config() {
        return {
          properties: {

            data: Array,

            currentPhoto: {
              type: Object,
              readOnly: true,
              observer: '_currentPhotoChanged'
            },

            _isAttached: {
              type: Boolean,
              value: false,
            },

          },

          observers: [
            '_dataChanged(data, _isAttached)'
          ],

        };
      }

      constructor() {
        super();
        this._photosInterval = null;
        this._photos = null;
      }

      connectedCallback() {
        super.connectedCallback();
        this._isAttached = true;
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        this._isAttached = false;
        this._removePhotosInterval();
      }

      _dataChanged(data) {
        if (!data || !data.albums || !data.albums.length) {
          this._removePhotosInterval();
          this._setCurrentPhoto(null);
          return;
        }

        // Create iron images
        this._photos = [];

        data.albums.forEach(album => {
          if (album.enabled === false) {
            return;
          }
          album.photos.forEach(photo => {
            // Get bigger url
            const image = photo.images.sort((a,b) => {
              return a.width - (b.width || 0);
            })[0];
            const imageElement = document.createElement('iron-image');
            imageElement.src = image.url;
            imageElement.sizing = 'contain';
            imageElement.preload = true;
            this._photos.push(imageElement);
          });
        });

        this._setCurrentPhoto(this._photos[0]);
        this._removePhotosInterval();

        this._photosInterval = setInterval(_ => {
          const index = this._photos.indexOf(this.currentPhoto);

          if (this._photos[index + 1]) {
            this._setCurrentPhoto(this._photos[index + 1]);
          } else {
            this._setCurrentPhoto(this._photos[0]);
          }
        }, 8000);
      }

      _removePhotosInterval() {
        if (this._photosInterval) {
          clearInterval(this._photosInterval);
          this._photosInterval = null;
        }
      }

      _currentPhotoChanged(currentPhoto, old) {
        if (currentPhoto) {
          Polymer.dom(this.$.container).appendChild(currentPhoto);

          requestAnimationFrame(_ => {
            const animation = currentPhoto.animate([
              {opacity: 0},
              {opacity: 1}
            ], {
              duration: 600,
              easing: 'cubic-bezier(0.47, 0, 0.745, 0.715)'
            });
          });
        }

        if (old) {
          requestAnimationFrame(_ => {
            const animation = old.animate([
              {opacity: 1},
              {opacity: 0}
            ], {
              duration: 600,
              easing: 'cubic-bezier(0.47, 0, 0.745, 0.715)'
            });
            animation.onfinish = _ => old.remove();
          });
        }
      }

    }

    customElements.define(AppPhotosPlayer.is, AppPhotosPlayer);


  </script>
</dom-module>